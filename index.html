<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MrdotaVPN</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 20px; }
        .nav-item.active { color: #60a5fa; }
        .page { display: none; opacity: 0; transition: opacity 0.3s; }
        .page.active { display: block; opacity: 1; }
        .avatar-glow { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
    </style>
</head>
<body class="pb-24 select-none">

    <div class="px-6 pt-6 pb-2 flex justify-between items-center z-10">
        <div class="flex items-center gap-2">
            <i class="fas fa-shield-alt text-blue-500 text-2xl"></i>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">MrdotaVPN</h1>
        </div>
        <div class="bg-green-500/10 border border-green-500/20 text-green-400 px-3 py-1 rounded-full text-xs font-mono flex items-center gap-1">
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div> Online
        </div>
    </div>

    <div class="p-5">

        <div id="page-home" class="page active">
            <div class="glass p-6 mb-6 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
                
                <div class="relative inline-block mb-3">
                    <img id="user-avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="w-20 h-20 rounded-full border-4 border-[#0f172a] avatar-glow mx-auto object-cover">
                    <div class="absolute bottom-0 right-0 bg-blue-500 text-white text-[10px] px-2 py-0.5 rounded-full border-2 border-[#0f172a]" id="user-id">ID: ...</div>
                </div>
                
                <h2 class="text-xl font-bold text-white mb-1" id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <p class="text-gray-400 text-sm mb-4">–° –Ω–∞–º–∏ —É–∂–µ <span id="user-days" class="text-blue-400 font-bold">0</span> –¥–Ω–µ–π</p>

                <div class="flex justify-between items-center bg-gray-900/50 p-4 rounded-xl">
                    <div class="text-left">
                        <p class="text-xs text-gray-500">–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ</p>
                        <p class="text-sm font-bold text-white" id="sub-status">...</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500">–ë–∞–ª–∞–Ω—Å</p>
                        <p class="text-sm font-bold text-green-400" id="user-balance">0.0 $</p>
                    </div>
                </div>
            </div>

            <h3 class="text-lg font-bold mb-3 text-gray-200">–¢–∞—Ä–∏—Ñ—ã</h3>
            <div class="space-y-3">
                <div class="glass p-4 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400 text-xl"><i class="fas fa-bolt"></i></div>
                        <div>
                            <div class="font-bold">1 –ú–µ—Å—è—Ü</div>
                            <div class="text-xs text-gray-400">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</div>
                        </div>
                    </div>
                    <button onclick="buy(2)" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl text-sm font-bold transition">2 USDT</button>
                </div>

                <div class="glass p-4 flex justify-between items-center border border-purple-500/30 relative">
                    <div class="absolute -top-2 -right-2 bg-purple-600 text-[10px] px-2 py-0.5 rounded text-white">Best</div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-400 text-xl"><i class="fas fa-star"></i></div>
                        <div>
                            <div class="font-bold">3 –ú–µ—Å—è—Ü–∞</div>
                            <div class="text-xs text-gray-400">–í—ã–≥–æ–¥–∞ 20%</div>
                        </div>
                    </div>
                    <button onclick="buy(5)" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded-xl text-sm font-bold transition">5 USDT</button>
                </div>
            </div>
        </div>

        <div id="page-crypto" class="page">
            <h2 class="text-2xl font-bold mb-4">–†—ã–Ω–æ–∫ <span class="text-xs bg-gray-700 px-2 py-1 rounded align-middle">Live</span></h2>
            <div id="crypto-list" class="space-y-3">
                <div class="text-center mt-10 text-gray-500"><i class="fas fa-circle-notch fa-spin text-2xl"></i><br>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            </div>
        </div>

        <div id="page-ref" class="page">
            <div class="glass p-6 text-center">
                <div class="w-16 h-16 bg-gradient-to-tr from-green-400 to-blue-500 rounded-full mx-auto flex items-center justify-center text-3xl mb-4 shadow-lg shadow-green-500/20">
                    ü§ù
                </div>
                <h2 class="text-2xl font-bold mb-2">–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π 5%</h2>
                <p class="text-gray-400 text-sm mb-6">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –≤ MrdotaVPN –∏ –ø–æ–ª—É—á–∞–π 5% –æ—Ç –∫–∞–∂–¥–æ–π –∏—Ö –ø–æ–∫—É–ø–∫–∏ –≤–µ—á–Ω–æ.</p>
                
                <div class="bg-gray-900/80 p-3 rounded-xl border border-dashed border-gray-600 flex items-center justify-between mb-6">
                    <div class="truncate text-xs text-gray-400 w-full text-left mr-2" id="ref-link">loading...</div>
                    <button onclick="copyRef()" class="text-blue-400 text-lg hover:text-white"><i class="far fa-copy"></i></button>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800/50 p-4 rounded-xl">
                        <div class="text-2xl font-bold text-white" id="ref-count">0</div>
                        <div class="text-xs text-gray-500">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div>
                    </div>
                    <div class="bg-gray-800/50 p-4 rounded-xl">
                        <div class="text-2xl font-bold text-green-400" id="ref-earn">0 $</div>
                        <div class="text-xs text-gray-500">–î–æ—Ö–æ–¥</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="fixed bottom-4 left-4 right-4 h-16 glass flex justify-around items-center z-50 shadow-2xl">
        <button onclick="nav('home', this)" class="nav-item active flex flex-col items-center gap-1 text-blue-500 w-1/3 transition">
            <i class="fas fa-home text-xl"></i>
            <span class="text-[10px] font-medium">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
        <button onclick="nav('crypto', this)" class="nav-item flex flex-col items-center gap-1 text-gray-500 w-1/3 transition">
            <i class="fas fa-chart-line text-xl"></i>
            <span class="text-[10px] font-medium">–ö—Ä–∏–ø—Ç–∞</span>
        </button>
        <button onclick="nav('ref', this)" class="nav-item flex flex-col items-center gap-1 text-gray-500 w-1/3 transition">
            <i class="fas fa-users text-xl"></i>
            <span class="text-[10px] font-medium">–†–µ—Ñ</span>
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        document.body.style.overflow = 'hidden'; 

        const user = tg.initDataUnsafe?.user;
        const userId = user?.id || 12345; 

        // UI Setup
        if(user) {
            document.getElementById('user-name').innerText = (user.first_name + ' ' + (user.last_name || '')).trim();
            document.getElementById('user-id').innerText = 'ID: ' + user.id;
            if(user.photo_url) document.getElementById('user-avatar').src = user.photo_url;
        }

        // --- NAVIGATION ---
        function nav(tab, button) {
            document.querySelectorAll('.page').forEach(el => {
                el.classList.remove('active');
                setTimeout(() => { if(!el.classList.contains('active')) el.style.display='none'; }, 300);
            });
            const target = document.getElementById('page-' + tab);
            target.style.display = 'block';
            setTimeout(() => target.classList.add('active'), 10);

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'text-blue-500'));
            button.classList.add('active', 'text-blue-500');

            if(tab === 'crypto') loadCrypto();
        }

        // --- API CALLS ---
        
        async function loadData() {
            try {
                const res = await fetch('/api/user_info', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await res.json();
                
                if(data.success) {
                    document.getElementById('user-balance').innerText = data.balance.toFixed(2) + ' $';
                    document.getElementById('sub-status').innerText = data.sub_end;
                    document.getElementById('user-days').innerText = data.days_with_us;
                    
                    document.getElementById('ref-link').innerText = data.ref_link;
                    document.getElementById('ref-count').innerText = data.referrals;
                    document.getElementById('ref-earn').innerText = data.earnings.toFixed(2) + ' $';
                    
                    if(data.sub_end !== "–ù–µ –∞–∫—Ç–∏–≤–Ω–∞") {
                        document.getElementById('sub-status').classList.add('text-green-400');
                    }
                }
            } catch(e) { console.error("Load error:", e); }
        }

        async function buy(price) {
            tg.MainButton.setText(`–û–ø–ª–∞—Ç–∏—Ç—å ${price} USDT`);
            tg.MainButton.show();
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
            if (tg.MainButton.custom_event_handler) {
                tg.MainButton.offClick(tg.MainButton.custom_event_handler);
            }

            // –ù–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            const handler = async () => {
                tg.MainButton.showProgress();
                try {
                    const res = await fetch('/api/create_payment', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ user_id: userId, price: price })
                    });
                    const data = await res.json();
                    
                    if(data.success) {
                        tg.openTelegramLink(data.url);
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É –∏–∑ –±–µ–∫–µ–Ω–¥–∞
                        tg.showAlert(`‚ùå –û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ${data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                    }
                } catch(e) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
                
                tg.MainButton.hideProgress();
                tg.MainButton.hide();
                tg.MainButton.offClick(handler);
            };
            
            tg.MainButton.onClick(handler);
            tg.MainButton.custom_event_handler = handler;
        }

        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ó–ê–ì–†–£–ó–ß–ò–ö –ö–†–ò–ü–¢–´ –ß–ï–†–ï–ó –ë–ï–ö–ï–ù–î ---
        async function loadCrypto() {
            const list = document.getElementById('crypto-list');
            list.innerHTML = `<div class="text-center mt-10 text-gray-500"><i class="fas fa-circle-notch fa-spin text-2xl"></i><br>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>`;
            
            try {
                // –ó–∞–ø—Ä–æ—Å –∫ –Ω–∞—à–µ–º—É —Å–µ—Ä–≤–µ—Ä—É, –∫–æ—Ç–æ—Ä—ã–π –∫—ç—à–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ
                const res = await fetch('/api/crypto_rates'); 
                const json_data = await res.json();
                
                if (!json_data.success) {
                    throw new Error(json_data.message || "Failed to fetch from backend.");
                }
                
                const data = json_data.rates;

                const coins = [
                    {id: 'bitcoin', name: 'Bitcoin', sym: 'BTC', img: 'https://assets.coingecko.com/coins/images/1/small/bitcoin.png'},
                    {id: 'ethereum', name: 'Ethereum', sym: 'ETH', img: 'https://assets.coingecko.com/coins/images/279/small/ethereum.png'},
                    {id: 'toncoin', name: 'Toncoin', sym: 'TON', img: 'https://assets.coingecko.com/coins/images/17980/small/ton_symbol.png'}
                ];

                list.innerHTML = '';
                coins.forEach(c => {
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ CoinGecko –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏)
                    if (!data[c.id]) return; 

                    const price = data[c.id].usd;
                    const change = data[c.id].usd_24h_change.toFixed(2);
                    const color = change >= 0 ? 'text-green-400' : 'text-red-400';
                    const icon = change >= 0 ? 'fa-caret-up' : 'fa-caret-down';

                    list.innerHTML += `
                        <div class="glass p-3 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <img src="${c.img}" class="w-8 h-8 rounded-full">
                                <div>
                                    <div class="font-bold text-white">${c.name}</div>
                                    <div class="text-xs text-gray-400">${c.sym}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-white">$${price}</div>
                                <div class="text-xs ${color}"><i class="fas ${icon}"></i> ${change}%</div>
                            </div>
                        </div>
                    `;
                });
            } catch(e) {
                list.innerHTML = `<div class="text-red-400 text-center text-sm p-4">‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>`;
            }
        }

        function copyRef() {
            const text = document.getElementById('ref-link').innerText;
            navigator.clipboard.writeText(text);
            tg.showPopup({message: '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'});
        }

        // Init
        loadData();
    </script>
</body>
</html>
