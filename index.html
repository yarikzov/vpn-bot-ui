<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MrdotaVPN Web App</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #00bcd4;
            --background-color: #1a1a2e;
            --card-background: #232946;
            --text-color: #ffffff;
            --light-text: #b8c1ec;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --font-family: 'Arial', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 450px;
            padding: 15px 0;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 2px solid var(--card-background);
        }

        .header h1 {
            color: var(--secondary-color);
            margin: 5px 0;
            font-size: 1.5em;
        }

        .tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            background: var(--card-background);
            border-radius: 10px;
            padding: 5px;
        }

        .tab-button {
            background: none;
            border: none;
            color: var(--light-text);
            padding: 10px 15px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            border-radius: 8px;
            flex-grow: 1;
            text-align: center;
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: var(--text-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .card {
            background: var(--card-background);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .card h3 {
            border-bottom: 2px solid var(--background-color);
            padding-bottom: 10px;
            margin-top: 0;
            color: var(--secondary-color);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #3e4465;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--light-text);
        }

        .info-value {
            font-weight: bold;
        }

        .button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        .button-primary {
            background-color: var(--primary-color);
            color: var(--text-color);
        }

        .button-primary:hover {
            background-color: #0056b3;
        }

        .ref-box {
            background: #3e4465;
            padding: 10px;
            border-radius: 8px;
            word-break: break-all;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .copy-button {
            background: var(--secondary-color);
            color: var(--background-color);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: bold;
        }

        .copy-button:active {
            background-color: #00a0b2;
        }

        .tariff-item {
            border: 1px solid var(--primary-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tariff-details h4 {
            margin: 0 0 5px 0;
            color: var(--primary-color);
        }
        
        .tariff-details p {
            margin: 0;
            font-size: 0.9em;
            color: var(--light-text);
        }

        .buy-button {
            background-color: var(--success-color);
            color: var(--text-color);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .buy-button:active {
            background-color: #1e7e34;
        }

        .alert {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }

        .alert-success {
            background-color: var(--success-color);
        }

        .alert-danger {
            background-color: var(--danger-color);
        }

        /* Crypto Rates Section */
        .crypto-rates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .crypto-card {
            background: #3e4465;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .crypto-card h4 {
            margin: 0 0 5px 0;
            color: var(--secondary-color);
        }

        .crypto-price {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .crypto-change {
            font-size: 0.9em;
        }

        .change-up {
            color: var(--success-color);
        }

        .change-down {
            color: var(--danger-color);
        }

        .loader {
            border: 4px solid var(--card-background);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MrdotaVPN Web3 Profile</h1>
            <p id="telegram-info">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
            <button class="tab-button" onclick="openTab('tariffs')">üí≥ –û–ø–ª–∞—Ç–∞</button>
            <button class="tab-button" onclick="openTab('referrals')">ü§ù –†–µ—Ñ–µ—Ä–∞–ª—ã</button>
            <button class="tab-button" onclick="openTab('crypto')">üìà –ö—Ä–∏–ø—Ç–∞</button>
        </div>

        <div id="profile" class="tab-content active">
            <div class="card">
                <h3>–ê–∫–∫–∞—É–Ω—Ç</h3>
                <div class="info-row">
                    <span class="info-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</span>
                    <span class="info-value" id="profile-username">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ID Telegram:</span>
                    <span class="info-value" id="profile-id">...</span>
                </div>
            </div>

            <div class="card">
                <h3>–ü–æ–¥–ø–∏—Å–∫–∞</h3>
                <div class="info-row">
                    <span class="info-label">–°—Ç–∞—Ç—É—Å:</span>
                    <span class="info-value" id="profile-sub-end">...</span>
                </div>
                <button class="button button-primary" onclick="requestVPN()">üîë –ü–æ–ª—É—á–∏—Ç—å/–û–±–Ω–æ–≤–∏—Ç—å VPN</button>
            </div>

            <div class="card">
                <h3>–ë–∞–ª–∞–Ω—Å –∏ –†–µ—Ñ–µ—Ä–∞–ª—ã</h3>
                <div class="info-row">
                    <span class="info-label">–ë–∞–ª–∞–Ω—Å (USDT):</span>
                    <span class="info-value" id="profile-balance">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:</span>
                    <span class="info-value" id="profile-referrals">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–î–æ—Ö–æ–¥ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:</span>
                    <span class="info-value" id="profile-earnings">...</span>
                </div>
            </div>
        </div>

        <div id="tariffs" class="tab-content">
            <div class="card">
                <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ</h3>
                <div id="tariffs-list">
                    <div class="loader"></div>
                </div>
                <p style="margin-top: 20px; text-align: center; color: var(--light-text);">
                    –û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ Crypto Bot (USDT).
                </p>
            </div>
        </div>
        
        <div id="referrals" class="tab-content">
            <div class="card">
                <h3>–ú–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</h3>
                <p style="color: var(--light-text);">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π, –∏ –ø–æ–ª—É—á–∞–π—Ç–µ 5% –æ—Ç –∫–∞–∂–¥–æ–π –æ–ø–ª–∞—Ç—ã –≤–∞—à–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞.</p>
                <div class="ref-box">
                    <span id="ref-link-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    <button class="copy-button" onclick="copyRefLink()">üîó –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                
                <div class="info-row">
                    <span class="info-label">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</span>
                    <span class="info-value" id="ref-count">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ (USDT):</span>
                    <span class="info-value" id="ref-earned">...</span>
                </div>
            </div>
        </div>

        <div id="crypto" class="tab-content">
            <div class="card">
                <h3>–ö—É—Ä—Å—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç (USD)</h3>
                <div id="crypto-rates-content" class="crypto-rates-grid">
                    <div class="loader"></div>
                </div>
                <p style="margin-top: 20px; font-size: 0.8em; color: var(--light-text); text-align: center;">
                    –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥. –ò—Å—Ç–æ—á–Ω–∏–∫: CoinGecko.
                </p>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = window.location.origin;
        let userData = {};
        
        // --- –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab-button[onclick*='${tabName}']`).classList.add('active');
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∫–ª–∞–¥–∫–∏
            if (tabName === 'tariffs') loadTariffs();
            if (tabName === 'crypto') loadCryptoRates();
            if (tabName === 'referrals') updateReferralTab();
        }

        function showAlert(message, type = 'success') {
            const container = document.querySelector('.container');
            let alertDiv = document.querySelector('.temporary-alert');
            if (alertDiv) alertDiv.remove();

            alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} temporary-alert`;
            alertDiv.textContent = message;
            
            container.insertBefore(alertDiv, container.firstChild.nextSibling);

            setTimeout(() => {
                alertDiv.remove();
            }, 4000);
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---

        async function loadUserInfo() {
            try {
                const initData = window.Telegram.WebApp.initDataUnsafe;
                const userId = initData.user.id;
                const username = initData.user.username || initData.user.first_name;

                document.getElementById('telegram-info').textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @${username}`;

                const response = await fetch(`${API_URL}/api/user_info`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });

                const data = await response.json();
                
                if (data.success) {
                    userData = { ...data, userId, username };
                    updateProfileTab(data);
                    updateReferralTab();
                } else {
                    showAlert(data.message, 'danger');
                }
            } catch (error) {
                console.error("Error fetching user info:", error);
                showAlert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.', 'danger');
            }
        }

        function updateProfileTab(data) {
            document.getElementById('profile-username').textContent = userData.username;
            document.getElementById('profile-id').textContent = userData.userId;
            document.getElementById('profile-balance').textContent = `${parseFloat(data.balance).toFixed(2)} USDT`;
            document.getElementById('profile-referrals').textContent = data.referrals;
            document.getElementById('profile-earnings').textContent = `${parseFloat(data.earnings).toFixed(2)} USDT`;
            
            const subEnd = document.getElementById('profile-sub-end');
            if (data.sub_end === '–ù–µ—Ç') {
                 subEnd.innerHTML = `<span style="color: var(--danger-color); font-weight: bold;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π</span>`;
            } else {
                 subEnd.innerHTML = `<span style="color: var(--success-color); font-weight: bold;">–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ ${new Date(data.sub_end).toLocaleDateString()}</span>`;
            }
        }

        // --- –í–∫–ª–∞–¥–∫–∞ –¢–∞—Ä–∏—Ñ—ã ---

        async function loadTariffs() {
            const listDiv = document.getElementById('tariffs-list');
            listDiv.innerHTML = '<div class="loader"></div>';
            
            try {
                const response = await fetch(`${API_URL}/api/tariffs`);
                const data = await response.json();
                
                if (data.success) {
                    listDiv.innerHTML = '';
                    data.tariffs.forEach(tariff => {
                        const item = document.createElement('div');
                        item.className = 'tariff-item';
                        item.innerHTML = `
                            <div class="tariff-details">
                                <h4>${tariff.name}</h4>
                                <p>${tariff.days} –¥–Ω–µ–π</p>
                            </div>
                            <button class="buy-button" onclick="createPayment(${tariff.id}, '${tariff.price}', '${tariff.currency}')">
                                –ö—É–ø–∏—Ç—å –∑–∞ ${tariff.price} ${tariff.currency}
                            </button>
                        `;
                        listDiv.appendChild(item);
                    });
                } else {
                    listDiv.innerHTML = `<p style="color: var(--danger-color);">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞—Ä–∏—Ñ—ã.</p>`;
                }
            } catch (error) {
                console.error("Error loading tariffs:", error);
                listDiv.innerHTML = `<p style="color: var(--danger-color);">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–∞—Ä–∏—Ñ–æ–≤.</p>`;
            }
        }

        async function createPayment(tariffId, price, currency) {
            if (!userData.userId) {
                showAlert('‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Web App.', 'danger');
                return;
            }

            showAlert(`üîÑ –°–æ–∑–¥–∞–Ω–∏–µ —Å—á–µ—Ç–∞ –¥–ª—è —Ç–∞—Ä–∏—Ñ–∞ ID ${tariffId}...`, 'primary');

            try {
                const response = await fetch(`${API_URL}/api/create_payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userData.userId, tariff_id: tariffId, price: price })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`‚úÖ –°—á–µ—Ç —Å–æ–∑–¥–∞–Ω! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ Telegram.`, 'success');
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º Web App –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —Å—á–µ—Ç—É –≤ CryptoBot
                    window.Telegram.WebApp.openTelegramLink(data.url);
                } else {
                    showAlert(`‚ùå –û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ${data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ CryptoBot.'}`, 'danger');
                }

            } catch (error) {
                console.error("Payment error:", error);
                showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞.', 'danger');
            }
        }
        
        // --- –í–∫–ª–∞–¥–∫–∞ –†–µ—Ñ–µ—Ä–∞–ª—ã ---
        
        function updateReferralTab() {
             if (userData.ref_link) {
                document.getElementById('ref-link-text').textContent = userData.ref_link;
                document.getElementById('ref-count').textContent = userData.referrals;
                document.getElementById('ref-earned').textContent = `${parseFloat(userData.earnings).toFixed(2)} USDT`;
            } else {
                document.getElementById('ref-link-text').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                document.getElementById('ref-count').textContent = '...';
                document.getElementById('ref-earned').textContent = '...';
            }
        }

        function copyRefLink() {
            const linkText = document.getElementById('ref-link-text').textContent;
            navigator.clipboard.writeText(linkText).then(() => {
                showAlert('üîó –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                showAlert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.', 'danger');
            });
        }
        
        function requestVPN() {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –≤ –±–æ—Ç–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞
            window.Telegram.WebApp.sendData('get_vpn_config');
            showAlert('üîë –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞.', 'primary');
        }

        // --- –í–∫–ª–∞–¥–∫–∞ –ö—Ä–∏–ø—Ç–∞ ---

        async function loadCryptoRates() {
            const contentDiv = document.getElementById('crypto-rates-content');
            
            try {
                const response = await fetch(`${API_URL}/api/crypto_rates`);
                const data = await response.json();
                
                if (data.success) {
                    contentDiv.innerHTML = '';
                    const rates = data.rates;
                    
                    for (const [key, value] of Object.entries(rates)) {
                        const name = key.charAt(0).toUpperCase() + key.slice(1);
                        const price = value.usd.toFixed(2);
                        const change = value.usd_24h_change.toFixed(2);
                        const isUp = change >= 0;

                        const cryptoCard = document.createElement('div');
                        cryptoCard.className = 'crypto-card';
                        cryptoCard.innerHTML = `
                            <h4>${name}</h4>
                            <div class="crypto-price">$${price}</div>
                            <div class="crypto-change ${isUp ? 'change-up' : 'change-down'}">
                                ${isUp ? '‚ñ≤' : '‚ñº'} ${change}% (24—á)
                            </div>
                        `;
                        contentDiv.appendChild(cryptoCard);
                    }
                } else {
                    contentDiv.innerHTML = `<p style="color: var(--danger-color);">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã.</p>`;
                }
            } catch (error) {
                console.error("Error loading crypto rates:", error);
                contentDiv.innerHTML = `<p style="color: var(--danger-color);">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫—É—Ä—Å–æ–≤.</p>`;
            }
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---

        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            loadUserInfo();
        } else {
            document.getElementById('telegram-info').textContent = "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤ Telegram –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞!";
            // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ Telegram:
            userData.userId = 12345;
            userData.username = "TestUser";
            loadUserInfo();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤–æ–π –≤–∫–ª–∞–¥–∫–∏
        loadTariffs();
    </script>
</body>
</html>
